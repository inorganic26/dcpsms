rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {

    // [1] 선생님인지 확인하는 함수 (관리자 권한)
    function isTeacher() {
      return request.auth != null && request.auth.token.email == "inorganic26@gmail.com";
    }

    // [2] 숙제 제출 파일 규칙
    // 경로는 반드시: homework_submissions / {숙제ID} / {학생ID} / {파일명} 이어야 함
    match /homework_submissions/{homeworkId}/{studentId}/{fileName} {
      
      // 읽기(Read): 선생님이거나, 파일 주인(학생) 본인이면 가능
      allow read: if isTeacher() || request.auth.uid == studentId;
      
      // 쓰기(Write - 업로드/수정/삭제): 선생님이거나, 파일 주인(학생) 본인이면 가능
      // (이 규칙 때문에 학생 A는 학생 B의 폴더에 파일을 절대 못 올림)
      allow write: if isTeacher() || request.auth.uid == studentId;
    }

    // [3] 그 외 모든 파일 (교재 PDF, 공지 이미지 등)
    // 나머지 모든 폴더는 선생님만 관리 가능 (학생은 업로드 불가)
    match /{allPaths=**} {
      allow read, write: if isTeacher();
    }
  }
}