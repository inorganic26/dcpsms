rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // =========================================================
    // ğŸ›¡ï¸ [ë³´ì•ˆ] ê¶Œí•œ í™•ì¸ ë„ìš°ë¯¸ í•¨ìˆ˜ë“¤
    // =========================================================
    
    // 1. ê´€ë¦¬ì ë˜ëŠ” ì„ ìƒë‹˜ì¸ì§€ í™•ì¸
    function isTeacher() {
      return request.auth != null && (
        request.auth.token.email == "inorganic26@gmail.com" || 
        request.auth.token.role == "teacher" ||
        request.auth.token.role == "admin"
      );
    }

    // 2. í•™ìƒ ë³¸ì¸ì¸ì§€ í™•ì¸
    function isStudent(studentId) {
      return request.auth != null && request.auth.uid == studentId;
    }

    // 3. í•™ë¶€ëª¨ë‹˜ ê¶Œí•œ í™•ì¸
    // (ë¡œê·¸ì¸ í† í°ì˜ ìë…€ IDì™€ ë°ì´í„°ì˜ ìë…€ IDê°€ ì¼ì¹˜í•´ì•¼ í•¨)
    function isParentOf(studentId) {
      return request.auth != null && 
             request.auth.token.role == 'parent' && 
             request.auth.token.studentId == studentId;
    }

    // =========================================================
    // ğŸ“‚ ì»¬ë ‰ì…˜ë³„ ë³´ì•ˆ ê·œì¹™
    // =========================================================

    // 1. ë°˜ ì •ë³´ (classes)
    // [ì¤‘ìš”] ë¡œê·¸ì¸ ì „ì—ë„ ë°˜ ëª©ë¡ì€ ë³´ì—¬ì•¼ í•˜ë¯€ë¡œ 'if true'ë¡œ ì„¤ì •
    match /classes/{classId} {
      allow read: if true; 
      allow write: if isTeacher();
    }

    // 2. í•™ìƒ ê°œì¸ ì •ë³´ (students)
    match /students/{studentId} {
      allow write: if isTeacher();
      // ì„ ìƒë‹˜, í•™ìƒ ë³¸ì¸, í•™ë¶€ëª¨ë‹˜ ì¡°íšŒ ê°€ëŠ¥
      allow read: if isTeacher() || isStudent(studentId) || isParentOf(studentId);
    }

    // 3. ì¼ì¼ í…ŒìŠ¤íŠ¸ ì ìˆ˜ (daily_tests)
    match /daily_tests/{testId} {
      allow write: if isTeacher();
      allow read: if isTeacher() ||
        (request.auth != null && resource.data.studentId == request.auth.uid) ||
        isParentOf(resource.data.studentId);
    }

    // 4. ì£¼ê°„ í…ŒìŠ¤íŠ¸ ì ìˆ˜ (weekly_tests)
    match /weekly_tests/{testId} {
      allow write: if isTeacher();
      // (ì£¼ê°„í…ŒìŠ¤íŠ¸ëŠ” í•™ìƒ ID í•„ë“œëª…ì´ 'uid'ì„)
      allow read: if isTeacher() ||
        (request.auth != null && resource.data.uid == request.auth.uid) ||
        isParentOf(resource.data.uid);
    }

    // 5. ìˆ™ì œ (homeworks)
    match /homeworks/{homeworkId} {
        // ìˆ™ì œ ëª©ë¡(ì œëª©, ë‚´ìš© ë“±)ì€ ë¡œê·¸ì¸í•œ ëˆ„êµ¬ë‚˜ ë³¼ ìˆ˜ ìˆìŒ
        allow read: if request.auth != null;
        allow write: if isTeacher();

        // [ì„œë¸Œ ì»¬ë ‰ì…˜] ìˆ™ì œ ì œì¶œë¬¼
        match /submissions/{studentId} {
            // ì œì¶œë¬¼ì€ ë³¸ì¸, ì„ ìƒë‹˜, í•™ë¶€ëª¨ë‹˜ë§Œ í™•ì¸ ê°€ëŠ¥
            allow read: if isTeacher() || isStudent(studentId) || isParentOf(studentId);
            allow write: if isTeacher() || isStudent(studentId);
        }
    }

    // 6. í•™ìŠµ í˜„í™©/ì§„ë„ (learning_status)
    match /learning_status/{statusId} {
      allow write: if isTeacher();
      allow read: if isTeacher() ||
        (request.auth != null && resource.data.studentId == request.auth.uid) ||
        isParentOf(resource.data.studentId);
    }

    // 7. ë¦¬í¬íŠ¸/ì„±ì í‘œ (reports)
    match /reports/{reportId} {
      allow write: if isTeacher();
      allow read: if isTeacher() ||
        (request.auth != null && resource.data.studentId == request.auth.uid) ||
        isParentOf(resource.data.studentId);
    }

    // 8. í•™ìƒ ê³¼ì œ ì œì¶œë¬¼ (student_assignments - ë³„ë„ ì»¬ë ‰ì…˜ì¸ ê²½ìš°)
    match /student_assignments/{assignmentId} {
      allow write: if isTeacher() || (request.auth != null && resource.data.studentId == request.auth.uid);
      allow read: if isTeacher() ||
        (request.auth != null && resource.data.studentId == request.auth.uid) ||
        isParentOf(resource.data.studentId);
    }

    // 9. ê³¼ëª©/êµì¬ ì •ë³´ (subjects, textbooks)
    // ë¡œê·¸ì¸í•œ ì‚¬ìš©ìëŠ” ì¡°íšŒ ê°€ëŠ¥
    match /subjects/{subjectId} {
      allow read: if request.auth != null;
      allow write: if isTeacher();
      
      match /{document=**} {
        allow read: if request.auth != null;
        allow write: if isTeacher();
      }
    }
    match /textbooks/{textbookId} {
      allow read: if request.auth != null;
      allow write: if isTeacher();
    }

    // 10. ì„ ìƒë‹˜ ëª©ë¡ (teachers)
    match /teachers/{teacherId} {
      allow read: if request.auth != null;
      allow write: if isTeacher();
    }

    // 11. ê·¸ ì™¸ ëª¨ë“  ë°ì´í„°
    // ê·œì¹™ì— ì—†ëŠ” ê²½ë¡œëŠ” ì„ ìƒë‹˜ë§Œ ì ‘ê·¼ ê°€ëŠ¥ (ë³´ì•ˆ ì•ˆì „ì¥ì¹˜)
    match /{document=**} {
      allow read, write: if isTeacher();
    }
  }
}