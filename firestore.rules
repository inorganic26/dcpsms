rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // =========================================
    // 1. 공통 함수
    // =========================================
    function isAuthenticated() {
      return request.auth != null;
    }

    // [핵심 수정] 관리자 권한 체크
    // : "inorganic26@gmail.com" 이메일이면 무조건 통과!
    function isAdminOrTeacher() {
      return isAuthenticated() && (
        request.auth.token.email == "inorganic26@gmail.com" || 
        exists(/databases/$(database)/documents/teachers/$(request.auth.uid)) ||
        exists(/databases/$(database)/documents/admins/$(request.auth.uid))
      );
    }

    // =========================================
    // 2. 컬렉션별 규칙
    // =========================================
    
    // Classes
    match /classes/{classId} {
      allow read: if true;
      allow write: if isAdminOrTeacher();
    }

    // Teachers
    match /teachers/{teacherId} {
      allow read: if true;
      allow write: if isAdminOrTeacher();
      // 선생님이 자기 정보 수정/생성 가능 (최초 등록용)
      allow create, update: if isAuthenticated() && request.auth.uid == teacherId;
    }

    // Admins
    match /admins/{adminId} {
      allow read: if true;
      allow write: if isAdminOrTeacher();
    }

    // Students
    match /students/{studentId} {
      allow read: if true;
      allow write: if isAdminOrTeacher();
    }

    // Textbooks / Subjects / Lessons
    match /textbooks/{textbookId} {
      allow read: if true;
      allow write: if isAdminOrTeacher();
    }

    match /subjects/{subjectId} {
      allow read: if true;
      allow write: if isAdminOrTeacher();

      match /lessons/{lessonId} {
        allow read: if true;
        allow write: if isAdminOrTeacher();

        match /submissions/{studentDocId} {
          allow read, write: if isAdminOrTeacher();
          allow read: if isAuthenticated();
          allow create, update: if isAuthenticated() && request.resource.data.studentDocId == studentDocId;
        }
      }
    }

    // Homework
    match /homeworks/{homeworkId} {
      allow read: if true;
      allow create, update, delete: if isAdminOrTeacher();
      
      match /submissions/{studentDocId} {
        allow read: if isAdminOrTeacher() || isAuthenticated();
        allow create, update: if isAuthenticated() && request.resource.data.studentDocId == studentDocId;
      }
    }

    // Videos / Lectures / Reports
    match /classVideos/{videoId} { allow read: if true; allow write: if isAdminOrTeacher(); }
    match /classLectures/{lectureId} { allow read: if true; allow write: if isAdminOrTeacher(); }
    match /reports/{reportId} { allow read: if true; allow write: if isAdminOrTeacher(); }

    // Tests
    match /daily_tests/{testId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if isAdminOrTeacher();
    }
    match /weekly_tests/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    match /{document=**} { allow read, write: if false; }
  }
}