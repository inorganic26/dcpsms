rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- í—¬í¼ í•¨ìˆ˜ (êµì‚¬/ê´€ë¦¬ììš©) ---
    // êµì‚¬/ê´€ë¦¬ìëŠ” Firebase Auth(ì´ë©”ì¼ ë“±)ë¡œ ë¡œê·¸ì¸í•œë‹¤ê³  ê°€ì •í•©ë‹ˆë‹¤.
    function isAuthenticated() {
      return request.auth != null;
    }
    function getUserRole(uid) {
      return get(/databases/$(database)/documents/users/$(uid)).data.role;
    }
    function isAdmin() {
      return isAuthenticated() && getUserRole(request.auth.uid) == 'admin';
    }
    function isTeacher() {
      return isAuthenticated() && getUserRole(request.auth.uid) == 'teacher';
    }

    // --- í•™ìƒ ë¡œê·¸ì¸ ë° ì‚¬ìš©ì„ ìœ„í•œ ê³µê°œ ê·œì¹™ ---

    // [ğŸš¨ ë³´ì•ˆ ê²½ê³ ] 
    // í•™ìƒ ë¡œê·¸ì¸ ì‹œ ë°˜ ëª©ë¡ì„ ë¶ˆëŸ¬ì™€ì•¼ í•˜ë¯€ë¡œ ëˆ„êµ¬ë‚˜(if true) ì½ì„ ìˆ˜ ìˆê²Œ í—ˆìš©í•©ë‹ˆë‹¤.
    match /classes/{classId} {
      allow read: if true;
      allow write: if isAdmin() || isTeacher();
    }

    // [ğŸš¨ğŸš¨ğŸš¨ ë§¤ìš° ì‹¬ê°í•œ ë³´ì•ˆ ê²½ê³ ]
    // í•™ìƒ ë¡œê·¸ì¸ ì‹œ (ì´ë¦„, ë¹„ë²ˆ)ì„ ë¹„êµí•´ì•¼ í•˜ë¯€ë¡œ ëˆ„êµ¬ë‚˜(if true) ì½ì„ ìˆ˜ ìˆê²Œ í—ˆìš©í•©ë‹ˆë‹¤.
    // ì´ ê·œì¹™ì€ 'password' í•„ë“œë¥¼ í¬í•¨í•œ ëª¨ë“  í•™ìƒ ì •ë³´ë¥¼ ì™¸ë¶€ì— ë…¸ì¶œì‹œí‚µë‹ˆë‹¤.
    match /students/{studentId} {
      allow read: if true;
      allow write: if isAdmin() || isTeacher();
    }

    // [ğŸš¨ ë³´ì•ˆ ê²½ê³ ]
    // í•™ìƒì´ ë¡œê·¸ì¸ í›„ ìˆ˜ì—…, ê³¼ëª©, êµê³¼ì„œ ì •ë³´ë¥¼ ì½ì–´ì•¼ í•˜ë¯€ë¡œ ëˆ„êµ¬ë‚˜(if true) ì½ê¸° í—ˆìš©í•©ë‹ˆë‹¤.
    match /subjects/{docId} {
      allow read: if true;
      allow write: if isAdmin() || isTeacher();
    }
    match /textbooks/{docId} {
      allow read: if true;
      allow write: if isAdmin() || isTeacher();
    }
    match /lessons/{docId} {
      allow read: if true;
      allow write: if isAdmin() || isTeacher();
    }

    // [ğŸš¨ğŸš¨ ë§¤ìš° ì‹¬ê°í•œ ë³´ì•ˆ ê²½ê³ ]
    // í•™ìƒì´ ìˆ™ì œë¥¼ ì½ê³ , ì œì¶œ(ì“°ê¸°)í•´ì•¼ í•˜ë¯€ë¡œ ëˆ„êµ¬ë‚˜(if true) ì½ê³  ì“°ê¸°ë¥¼ í—ˆìš©í•©ë‹ˆë‹¤.
    // ì´ ê·œì¹™ì€ ëˆ„êµ¬ë‚˜ ìˆ™ì œ ì •ë³´ë¥¼ ìŠ¤íŒ¸ì²˜ëŸ¼ ë§ˆêµ¬ ìƒì„±í•  ìˆ˜ ìˆê²Œ í—ˆìš©í•©ë‹ˆë‹¤.
    match /homeworks/{homeworkId} {
      allow read: if true;
      allow write: if true; // 'create'ì™€ 'update'ë¥¼ ìœ„í•´ 'write'ë¥¼ ì—½ë‹ˆë‹¤.
    }

    // --- êµì‚¬/ê´€ë¦¬ì ì „ìš© ë³´ì•ˆ ê·œì¹™ ---

    // 'users' (êµì‚¬/ê´€ë¦¬ì ì—­í•  ì •ë³´)ëŠ” ì¸ì¦ëœ ì‚¬ìš©ìë§Œ ì ‘ê·¼
    match /users/{userId} {
      allow read, write: if isAdmin() || (isTeacher() && request.auth.uid == userId);
    }
    
    // 'teachers' (êµì‚¬ ì •ë³´)ëŠ” ì¸ì¦ëœ ì‚¬ìš©ìë§Œ ì ‘ê·¼
    match /teachers/{teacherId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin() || (isTeacher() && request.auth.uid == teacherId);
    }

    // (ì´ ì™¸ì˜ ëª¨ë“  ì»¬ë ‰ì…˜ì€ ê¸°ë³¸ì ìœ¼ë¡œ ì ‘ê·¼ ê±°ë¶€)
  }
}