rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // =========================================
    // 공통 헬퍼 함수
    // =========================================
    
    // 1. 로그인 여부 확인
    function isAuthenticated() {
      return request.auth != null;
    }

    // 2. [수정됨] 관리자 권한 확인 (임시 완화)
    // 원래는 토큰(request.auth.token.role)을 검사해야 하지만, 
    // Cloud Functions 문제로 권한 오류가 나므로 '로그인만 하면 OK'로 변경합니다.
    function isAdminOrTeacher() {
      // return isAuthenticated() && 'role' in request.auth.token && ... (기존 엄격한 규칙)
      return isAuthenticated(); // ✨ [변경] 로그인만 되어 있으면 관리자 권한 인정
    }

    // =========================================
    // classes 컬렉션 (반 목록)
    // =========================================
    match /classes/{classId} {
      allow read: if true;
      allow write: if isAdminOrTeacher();
    }

    // =========================================
    // teachers 컬렉션 (선생님 목록)
    // =========================================
    match /teachers/{teacherId} {
      allow read: if true;
      allow write: if isAdminOrTeacher();
    }

    // =========================================
    // students 컬렉션 (학생 목록)
    // =========================================
    match /students/{studentId} {
      allow read: if true;
      allow write: if isAdminOrTeacher();
    }

    // =========================================
    // textbooks / subjects / lessons (학습 데이터)
    // =========================================
    match /textbooks/{textbookId} {
      allow read: if true;
      allow write: if isAdminOrTeacher();
    }

    match /subjects/{subjectId} {
      allow read: if true;
      allow write: if isAdminOrTeacher();

      match /lessons/{lessonId} {
        allow read: if true;
        allow write: if isAdminOrTeacher();

        match /submissions/{studentDocId} {
          allow read: if isAdminOrTeacher() || (isAuthenticated() && request.auth.uid == studentDocId);
          allow create, update: if isAuthenticated() && request.resource.data.studentDocId == studentDocId;
          allow delete: if isAdminOrTeacher();
        }
      }
    }

    // =========================================
    // homeworks (숙제)
    // =========================================
    match /homeworks/{homeworkId} {
      allow read: if true;
      // 학생 숙제 제출(update) 허용
      allow update: if isAuthenticated();
      // 숙제 생성/삭제는 관리자만
      allow create, delete: if isAdminOrTeacher();
      
      match /submissions/{studentDocId} {
        allow read: if isAdminOrTeacher() || (isAuthenticated() && request.auth.uid == studentDocId);
        allow write: if isAuthenticated() && request.resource.data.studentDocId == studentDocId;
      }
    }

    // =========================================
    // classVideos / classLectures / reports
    // =========================================
    match /classVideos/{videoId} {
      allow read: if true;
      allow write: if isAdminOrTeacher();
    }
    
    match /classLectures/{lectureId} {
      allow read: if true;
      allow write: if isAdminOrTeacher();
    }

    match /reports/{reportId} {
      allow read: if true;
      allow write: if isAdminOrTeacher();
    }

    // =========================================
    // 일일 테스트 (daily_tests)
    // =========================================
    match /daily_tests/{testId} {
      allow read, write: if isAuthenticated();
    }

    // 기본 거부
    match /{document=**} {
      allow read, write: if false;
    }
  }
}