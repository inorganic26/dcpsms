rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // =========================================================
    // ğŸ›¡ï¸ [ë³´ì•ˆ] ê¶Œí•œ í™•ì¸ ë„ìš°ë¯¸ í•¨ìˆ˜ë“¤
    // =========================================================
    
    // 1. ê´€ë¦¬ì/ì„ ìƒë‹˜ í™•ì¸
    function isTeacher() {
      return request.auth != null && (
        request.auth.token.email == "inorganic26@gmail.com" || 
        request.auth.token.role == "teacher" ||
        request.auth.token.role == "admin"
      );
    }

    // 2. í•™ìƒ ë³¸ì¸ í™•ì¸ (ID ëŒ€ì¡°)
    function isStudent(studentId) {
      return request.auth != null && request.auth.uid == studentId;
    }

    // 3. í•™ë¶€ëª¨ë‹˜ í™•ì¸ (í† í° ë‚´ ìë…€ ID ëŒ€ì¡°)
    function isParentOf(studentId) {
      return request.auth != null && 
             request.auth.token.role == 'parent' && 
             request.auth.token.studentId == studentId;
    }

    // =========================================================
    // ğŸ“‚ ì»¬ë ‰ì…˜ë³„ ë³´ì•ˆ ê·œì¹™
    // =========================================================

    // 1. í•™ìƒ ê°œì¸ ì •ë³´ (students)
    match /students/{studentId} {
      allow read, write: if isTeacher();
      allow read: if isStudent(studentId) || isParentOf(studentId);
    }

    // 2. ë°˜ ì •ë³´ (classes)
    match /classes/{classId} {
      allow write: if isTeacher();
      allow read: if true; // ë¡œê·¸ì¸ ì „ ëª©ë¡ ë¡œë”© í—ˆìš©
    }

    // 3. [ìˆ˜ì •ë¨] ì¼ì¼ í…ŒìŠ¤íŠ¸ (daily_tests)
    match /daily_tests/{testId} {
      // ì„ ìƒë‹˜: ëª¨ë“  ê¶Œí•œ
      allow write: if isTeacher();
      
      // [ì¶”ê°€] í•™ìƒ: ìê¸° ì ìˆ˜ ë“±ë¡(create) ë° ì‚­ì œ(delete) í—ˆìš©
      allow create: if isStudent(request.resource.data.studentId);
      allow delete: if isStudent(resource.data.studentId);
      
      // ì¡°íšŒ ê·œì¹™
      allow read: if isTeacher() ||
        (request.auth != null && resource.data.studentId == request.auth.uid) ||
        isParentOf(resource.data.studentId);
    }

    // 4. [ìˆ˜ì •ë¨] ì£¼ê°„ í…ŒìŠ¤íŠ¸ (weekly_tests)
    match /weekly_tests/{testId} {
      allow write: if isTeacher();

      // [ì¶”ê°€] í•™ìƒ: ì˜ˆì•½ ë° ì ìˆ˜ ì €ì¥ í—ˆìš© (uid í•„ë“œ ì‚¬ìš©)
      // create(ì‹ ê·œ ì˜ˆì•½) ë° update(ì ìˆ˜ ì…ë ¥) í—ˆìš©
      allow write: if isStudent(request.resource.data.uid);

      allow read: if isTeacher() ||
        (request.auth != null && resource.data.uid == request.auth.uid) ||
        isParentOf(resource.data.uid);
    }

    // 5. ìˆ™ì œ (homeworks)
    match /homeworks/{homeworkId} {
        allow read: if request.auth != null;
        allow write: if isTeacher();

        // 5-1. [ìˆ˜ì •ë¨] ìˆ™ì œ ì œì¶œë¬¼ (submissions)
        match /submissions/{submissionId} {
            // ì½ê¸°: ì„ ìƒë‹˜, ë³¸ì¸(IDì¼ì¹˜), ë³¸ì¸(í•„ë“œì¼ì¹˜), í•™ë¶€ëª¨
            allow read: if isTeacher() || 
                       isStudent(submissionId) || 
                       (request.auth != null && resource.data.studentId == request.auth.uid) ||
                       isParentOf(submissionId) ||
                       (request.auth != null && request.auth.token.role == 'parent' && resource.data.studentId == request.auth.token.studentId);

            // ì“°ê¸°: ì„ ìƒë‹˜, í•™ìƒ ë³¸ì¸
            allow write: if isTeacher() || 
                        isStudent(submissionId) ||
                        (request.auth != null && request.resource.data.studentId == request.auth.uid);
        }
    }

    // 6. í•™ìŠµ í˜„í™© (learning_status)
    match /learning_status/{statusId} {
      allow write: if isTeacher();
      allow read: if isTeacher() ||
        (request.auth != null && resource.data.studentId == request.auth.uid) ||
        isParentOf(resource.data.studentId);
    }

    // 7. ë¦¬í¬íŠ¸ (reports)
    match /reports/{reportId} {
      allow write: if isTeacher();
      allow read: if isTeacher() ||
        (request.auth != null && resource.data.studentId == request.auth.uid) ||
        isParentOf(resource.data.studentId);
    }

    // 8. ê³¼ëª©/êµì¬/ì„ ìƒë‹˜ ë“± ê³µìš© ì •ë³´
    match /subjects/{subjectId} {
      allow read, write: if isTeacher();
      allow read: if request.auth != null;
      match /{document=**} {
        allow read: if request.auth != null;
        allow write: if isTeacher();
      }
    }
    match /textbooks/{textbookId} {
      allow read, write: if isTeacher();
      allow read: if request.auth != null;
    }
    match /teachers/{teacherId} {
      allow read, write: if isTeacher();
      allow read: if request.auth != null;
    }
    
    // 9. í•™ìƒ ê³¼ì œ ì œì¶œë¬¼ (student_assignments) - ë³„ë„ ì»¬ë ‰ì…˜ì¸ ê²½ìš°
    match /student_assignments/{assignmentId} {
      allow read, write: if isTeacher();
      allow read, write: if isStudent(resource.data.studentId); // í•™ìƒ ë³¸ì¸ ì“°ê¸° í—ˆìš©
      allow create: if isStudent(request.resource.data.studentId);
      allow read: if isParentOf(resource.data.studentId);
    }

    // 10. ê·¸ ì™¸ ì°¨ë‹¨
    match /{document=**} {
      allow read, write: if isTeacher();
    }
  }
}