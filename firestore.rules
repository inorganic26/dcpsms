rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // =========================================
    // ê³µí†µ í—¬í¼
    // =========================================
    function isAuthenticated() {
      // ìµëª… ë¡œê·¸ì¸(anonymous auth) í¬í•¨: request.auth != null ì´ë©´ true
      return request.auth != null;
    }

    // ì§€ê¸ˆì€ ì—­í• (ê´€ë¦¬ì/êµì‚¬)ì„ ë”°ë¡œ êµ¬ë¶„ ì•ˆ í•˜ê³ 
    // "ë¡œê·¸ì¸ë§Œ ë˜ì–´ ìˆìœ¼ë©´ ê´€ë¦¬ì/êµì‚¬ ì·¨ê¸‰"ìœ¼ë¡œ ë‘” ìƒíƒœ.
    // ì‹¤ì œ ë°°í¬ì—ì„œëŠ” custom claimsë¡œ role ì²´í¬í•´ì„œ ê°•í™”í•´ì•¼ í•¨.
    function isAdminOrTeacher() {
      // TODO: ì‹¤ì œ ìš´ì˜ì—ì„œëŠ” custom claims (request.auth.token.role) ì²´í¬ í•„ìš”
      return isAuthenticated();
    }

    // =========================================
    // classes ì»¬ë ‰ì…˜
    // =========================================
    match /classes/{classId} {
      allow read: if isAuthenticated();
      allow write: if isAdminOrTeacher();
    }

    // =========================================
    // students ì»¬ë ‰ì…˜
    // =========================================
    match /students/{studentId} {
      allow read: if isAuthenticated();
      allow write: if isAdminOrTeacher();
    }

    // =========================================
    // subjects ì»¬ë ‰ì…˜ (+ í•˜ìœ„ ì»¬ë ‰ì…˜)
    // =========================================
    match /subjects/{subjectId} {
      allow read: if isAuthenticated();
      allow write: if isAdminOrTeacher();

      match /textbooks/{textbookId} {
        allow read: if isAuthenticated();
        allow write: if isAdminOrTeacher();
      }

      match /lessons/{lessonId} {
        allow read: if isAuthenticated();
        allow write: if isAdminOrTeacher();

        // --- ğŸ‘‡ ìˆ˜ì •ëœ submissions ê·œì¹™ ğŸ‘‡ ---
        match /submissions/{submissionUid} {
          // ì½ê¸°: ë¡œê·¸ì¸í–ˆê³ , ì œì¶œì ë³¸ì¸ì´ê±°ë‚˜ í˜¹ì€ êµì‚¬/ê´€ë¦¬ìì¼ ë•Œ
          allow read: if isAuthenticated() &&
                        (request.auth.uid == submissionUid || isAdminOrTeacher());
          // ìƒì„±/ìˆ˜ì •: ë¡œê·¸ì¸í–ˆê³ , ì œì¶œì ë³¸ì¸ì¼ ë•Œë§Œ í—ˆìš©
          allow create, update: if isAuthenticated() && request.auth.uid == submissionUid;
          // ì‚­ì œ: êµì‚¬/ê´€ë¦¬ìë§Œ í—ˆìš©
          allow delete: if isAdminOrTeacher();
          // allow write ê·œì¹™ ì œê±° (create, updateë¡œ ëŒ€ì²´)
        }
        // --- ğŸ‘† ---
      }
    }

    // =========================================
    // lessons ì»¬ë ‰ì…˜ (ìµœìƒìœ„) - í•™ìƒ ì•± í˜¸í™˜ìš© (í˜„ì¬ ì‚¬ìš© ì•ˆ í•¨)
    // =========================================
    match /lessons/{lessonId} {
      allow read: if isAuthenticated();
      allow write: if isAdminOrTeacher();
    }

    // =========================================
    // homeworks ì»¬ë ‰ì…˜ (+ í•˜ìœ„ submissions)
    // =========================================
    match /homeworks/{homeworkId} {
      allow read: if isAuthenticated();
      allow write: if isAdminOrTeacher(); // ìˆ™ì œ ìƒì„±/ìˆ˜ì •ì€ ê´€ë¦¬ì/êµì‚¬ë§Œ

      match /submissions/{submissionUid} {
        // ì½ê¸°: ë³¸ì¸ ë˜ëŠ” ê´€ë¦¬ì/êµì‚¬
        allow read: if isAuthenticated() &&
                    (request.auth.uid == submissionUid || isAdminOrTeacher());
        // ì“°ê¸°(ìƒì„±/ìˆ˜ì •): ë³¸ì¸ ë˜ëŠ” ê´€ë¦¬ì/êµì‚¬ (êµì‚¬ê°€ ìˆ˜ì •í•  ìˆ˜ë„ ìˆìœ¼ë¯€ë¡œ write ìœ ì§€)
        allow write: if isAuthenticated() &&
                     (request.auth.uid == submissionUid || isAdminOrTeacher());
        // ì‚­ì œ: ê´€ë¦¬ì/êµì‚¬ë§Œ
        allow delete: if isAdminOrTeacher();
      }
    }

    // =========================================
    // teachers ì»¬ë ‰ì…˜
    // =========================================
    match /teachers/{teacherId} {
      allow read, write: if isAdminOrTeacher();
    }

    // =========================================
    // classVideos / classLectures (ìˆ˜ì—…/ì§ˆë¬¸ ì˜ìƒ)
    // =========================================
    match /classVideos/{videoId} {
      allow read: if isAuthenticated();
      allow write: if isAdminOrTeacher();
    }
    match /classLectures/{lectureId} {
      allow read: if isAuthenticated();
      allow write: if isAdminOrTeacher();
    }

    // =========================================
    // ê¸°ë³¸ ê±°ë¶€
    // =========================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}