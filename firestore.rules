rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // =========================================
    // 공통 헬퍼 함수
    // =========================================
    
    // 1. 로그인 여부 확인
    function isAuthenticated() {
      return request.auth != null;
    }

    // 2. [수정됨] 관리자 또는 선생님 권한 확인 (보안 강화)
    // 로그인되어 있고(AND), 토큰에 'role' 속성이 있으며, 그 값이 'admin'이나 'teacher'여야 함
    function isAdminOrTeacher() {
      return isAuthenticated() 
             && 'role' in request.auth.token 
             && (request.auth.token.role == 'admin' || request.auth.token.role == 'teacher');
    }

    // =========================================
    // classes 컬렉션
    // =========================================
    match /classes/{classId} {
      allow read: if isAuthenticated();
      allow write: if isAdminOrTeacher();
    }

    // =========================================
    // students 컬렉션
    // =========================================
    match /students/{studentId} {
      allow read: if isAuthenticated();
      // 학생 관리는 관리자/선생님만 가능
      allow write: if isAdminOrTeacher();
    }

    // =========================================
    // subjects 컬렉션 (+ 하위 컬렉션)
    // =========================================
    match /subjects/{subjectId} {
      allow read: if isAuthenticated();
      allow write: if isAdminOrTeacher();

      match /textbooks/{textbookId} {
        allow read: if isAuthenticated();
        allow write: if isAdminOrTeacher();
      }

      match /lessons/{lessonId} {
        allow read: if isAuthenticated();
        allow write: if isAdminOrTeacher();

        // submissions 하위 컬렉션
        match /submissions/{studentDocId} {
          // 읽기: 교사/관리자만 (학생은 자기 것만 읽게 하려면 수정 필요하지만, 현재 로직 유지)
          allow read: if isAdminOrTeacher();
          
          // 생성/수정: 본인(studentDocId)이거나 관리자/선생님
          // (학생 앱 로직상 본인의 studentDocId로만 저장하므로 이중 검증)
          allow create, update: if isAdminOrTeacher() || (isAuthenticated() && request.resource.data.studentDocId == studentDocId);
          
          // 삭제: 교사/관리자만
          allow delete: if isAdminOrTeacher();
        }
      }
    }

    // =========================================
    // homeworks 컬렉션 (+ 하위 submissions)
    // =========================================
    match /homeworks/{homeworkId} {
      allow read: if isAuthenticated();
      allow write: if isAdminOrTeacher();

      match /submissions/{studentDocId} {
        allow read: if isAdminOrTeacher();
        // 본인 제출물이거나 관리자/선생님인 경우만 쓰기 허용
        allow write: if isAdminOrTeacher() || (isAuthenticated() && request.resource.data.studentDocId == studentDocId);
        allow delete: if isAdminOrTeacher();
      }
    }

    // =========================================
    // teachers 컬렉션
    // =========================================
    match /teachers/{teacherId} {
      // 교사 정보는 관리자/교사만 접근 가능
      allow read, write: if isAdminOrTeacher();
    }

    // =========================================
    // classVideos / classLectures (수업/질문 영상)
    // =========================================
    match /classVideos/{videoId} {
      allow read: if isAuthenticated();
      allow write: if isAdminOrTeacher();
    }
    match /classLectures/{lectureId} {
      allow read: if isAuthenticated();
      allow write: if isAdminOrTeacher();
    }

    // =========================================
    // 기본 거부 (나머지 모든 경로는 차단)
    // =========================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}