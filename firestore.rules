rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // =========================================================
    // ğŸ›¡ï¸ [ë³´ì•ˆ] ê¶Œí•œ í™•ì¸ ë„ìš°ë¯¸ í•¨ìˆ˜ë“¤
    // =========================================================
    
    function isTeacher() {
      return request.auth != null && (
        request.auth.token.email == "inorganic26@gmail.com" || 
        request.auth.token.role == "teacher" ||
        request.auth.token.role == "admin"
      );
    }

    // í•™ìƒ ë³¸ì¸ì¸ì§€ í™•ì¸ (ë‚´ IDë‘ ë¬¸ì„œì˜ ì£¼ì¸ IDê°€ ê°™ì€ì§€)
    function isStudent(studentId) {
      return request.auth != null && request.auth.uid == studentId;
    }

    // í•™ë¶€ëª¨ì¸ì§€ í™•ì¸
    function isParentOf(studentId) {
      return request.auth != null && 
             request.auth.token.role == 'parent' && 
             request.auth.token.studentId == studentId;
    }

    // =========================================================
    // ğŸ“‚ ì»¬ë ‰ì…˜ë³„ ë³´ì•ˆ ê·œì¹™
    // =========================================================

    // 1. í•™ìƒ ê°œì¸ ì •ë³´ (students)
    match /students/{studentId} {
      allow read, write: if isTeacher();
      allow read: if isStudent(studentId) || isParentOf(studentId);
    }

    // 2. ë°˜ ì •ë³´ (classes)
    match /classes/{classId} {
      allow write: if isTeacher();
      allow read: if true;
    }

    // 3. ì¼ì¼ í…ŒìŠ¤íŠ¸ (daily_tests)
    // ğŸš€ [ìˆ˜ì •ë¨] í•™ìƒì€ ìƒì„±/ìˆ˜ì • ê°€ëŠ¥í•˜ì§€ë§Œ ì‚­ì œëŠ” ë¶ˆê°€ëŠ¥ (ë°ì´í„° ë³´í˜¸)
    match /daily_tests/{testId} {
      allow write: if isTeacher();
      
      // ìƒì„±: ë‚´ IDë¡œ ë§Œë“¤ë©´ OK
      allow create: if isStudent(request.resource.data.studentId);
      
      // ìˆ˜ì •: ë‚´ ë¬¸ì„œë¼ë©´ ë‚´ìš© ìˆ˜ì • ê°€ëŠ¥ (ì‚­ì œëŠ” ë¶ˆê°€ëŠ¥)
      allow update: if isStudent(resource.data.studentId);
      
      // ì‚­ì œ: í•™ìƒì€ ì‚­ì œ ë¶ˆê°€ (ì„ ìƒë‹˜ë§Œ write ê¶Œí•œìœ¼ë¡œ ê°€ëŠ¥)
      allow delete: if false;

      // ì½ê¸°: ì„ ìƒë‹˜, ë‚˜, ìš°ë¦¬ ë¶€ëª¨ë‹˜
      allow read: if isTeacher() ||
        (request.auth != null && resource.data.studentId == request.auth.uid) ||
        isParentOf(resource.data.studentId);
    }

    // 4. ì£¼ê°„ í…ŒìŠ¤íŠ¸ (weekly_tests)
    // ğŸš€ [ìˆ˜ì •ë¨] ë°ì´í„°ê°€ 'uid' í•„ë“œë¡œ ì €ì¥ë˜ë¯€ë¡œ ê·œì¹™ë„ 'uid'ë¥¼ ê²€ì‚¬í•˜ë„ë¡ ìˆ˜ì • (í•™ë¶€ëª¨/í•™ìƒì•± ì˜¤ë¥˜ í•´ê²°)
    match /weekly_tests/{testId} {
      allow write: if isTeacher();
      
      // ìƒì„±: ë‚´ ID(uid)ë¡œ ë§Œë“¤ë©´ OK
      allow create: if request.auth.uid == request.resource.data.uid;
      
      // ìˆ˜ì •: ë‚´ ID(uid)ë¡œ ëœ ë¬¸ì„œë©´ OK
      allow update: if request.auth.uid == resource.data.uid;
      
      // ì½ê¸°: ì„ ìƒë‹˜, ë³¸ì¸(uid ì¼ì¹˜), ë¶€ëª¨ë‹˜(uid í•„ë“œê°€ ìë…€ IDì™€ ì¼ì¹˜)
      allow read: if isTeacher() ||
        (request.auth != null && resource.data.uid == request.auth.uid) ||
        isParentOf(resource.data.uid);
    }

    // 5. ìˆ™ì œ (homeworks)
    match /homeworks/{homeworkId} {
        allow read: if request.auth != null;
        allow write: if isTeacher();

        // 5-1. ìˆ™ì œ ì œì¶œë¬¼ (submissions)
        // ğŸš€ [í•µì‹¬ ìˆ˜ì •] ë¯¸ì œì¶œ ìƒíƒœì—ì„œë„ ì—ëŸ¬ê°€ ì•ˆ ë‚˜ë„ë¡ ë¬¸ì„œID(submissionId)ë¡œ ë³¸ì¸ í™•ì¸
        match /submissions/{submissionId} {
            // ì½ê¸°: ë¬¸ì„œ ë‚´ìš©(resource.data) ëŒ€ì‹  ë¬¸ì„œ ì œëª©(submissionId)ì´ ë‚´ IDì¸ì§€ í™•ì¸
            allow read: if isTeacher() ||
                       (request.auth != null && submissionId == request.auth.uid) ||
                       isParentOf(submissionId);
            
            // ìƒì„±: ë‚´ IDë¡œ ì œì¶œ
            allow create: if isStudent(request.resource.data.studentId);
            
            // ìˆ˜ì •/ì‚­ì œ: ë‚´ ì œì¶œë¬¼ì´ë©´ ìˆ˜ì • ê°€ëŠ¥
            allow update, delete: if isStudent(resource.data.studentId);
        }
    }

    // 6. í•™ìŠµ í˜„í™© (learning_status)
    match /learning_status/{statusId} {
      allow write: if isTeacher();
      allow read: if isTeacher() ||
        (request.auth != null && resource.data.studentId == request.auth.uid) ||
        isParentOf(resource.data.studentId);
    }

    // 7. ë¦¬í¬íŠ¸ (reports)
    match /reports/{reportId} {
      allow write: if isTeacher();
      allow read: if isTeacher() ||
        (request.auth != null && resource.data.studentId == request.auth.uid) ||
        isParentOf(resource.data.studentId);
    }

    // 8. ê³µìš© ì •ë³´ (ê³¼ëª©, êµì¬, ì„ ìƒë‹˜, ì˜ìƒ)
    match /subjects/{subjectId} {
      allow read, write: if isTeacher();
      allow read: if request.auth != null;
      match /{document=**} {
        allow read: if request.auth != null;
        allow write: if isTeacher();
      }
    }
    match /textbooks/{textbookId} {
      allow read, write: if isTeacher();
      allow read: if request.auth != null;
    }
    match /teachers/{teacherId} {
      allow read, write: if isTeacher();
      allow read: if request.auth != null;
    }
    match /classLectures/{videoId} {
      allow write: if isTeacher();
      allow read: if request.auth != null;
    }
    match /classVideos/{videoId} {
      allow write: if isTeacher();
      allow read: if request.auth != null;
    }
    
    // 9. í•™ìƒ ê³¼ì œ (êµ¬ë²„ì „ í˜¸í™˜)
    match /student_assignments/{assignmentId} {
      allow read, write: if isTeacher();
      allow create: if isStudent(request.resource.data.studentId);
      allow update, delete: if isStudent(resource.data.studentId);
      allow read: if isParentOf(resource.data.studentId);
    }

    // 10. ê·¸ ì™¸ ì°¨ë‹¨
    match /{document=**} {
      allow read, write: if isTeacher();
    }
  }
}