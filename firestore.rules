rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // =========================================
    // ê³µí†µ í—¬í¼
    // =========================================
    function isAuthenticated() {
      // ìµëª… ë¡œê·¸ì¸(anonymous auth) í¬í•¨: request.auth != null ì´ë©´ true
      return request.auth != null;
    }

    // ì§€ê¸ˆì€ ì—­í• (ê´€ë¦¬ì/êµì‚¬)ì„ ë”°ë¡œ êµ¬ë¶„ ì•ˆ í•˜ê³ 
    // "ë¡œê·¸ì¸ë§Œ ë˜ì–´ ìˆìœ¼ë©´ ê´€ë¦¬ì/êµì‚¬ ì·¨ê¸‰"ìœ¼ë¡œ ë‘” ìƒíƒœ.
    // ì‹¤ì œ ë°°í¬ì—ì„œëŠ” custom claimsë¡œ role ì²´í¬í•´ì„œ ê°•í™”í•´ì•¼ í•¨.
    function isAdminOrTeacher() {
      // TODO: ì‹¤ì œ ìš´ì˜ì—ì„œëŠ” custom claims (request.auth.token.role) ì²´í¬ í•„ìš”
      return isAuthenticated();
    }

    // =========================================
    // classes ì»¬ë ‰ì…˜
    // =========================================
    match /classes/{classId} {
      allow read: if isAuthenticated();
      allow write: if isAdminOrTeacher();
    }

    // =========================================
    // students ì»¬ë ‰ì…˜
    // =========================================
    match /students/{studentId} {
      allow read: if isAuthenticated();
      // í•™ìƒ ë³¸ì¸ë„ ìê¸° ì •ë³´ ìˆ˜ì • ê°€ëŠ¥í•˜ê²Œ í•˜ë ¤ë©´? (ì˜ˆ: ë¹„ë°€ë²ˆí˜¸ ë³€ê²½)
      // allow update: if isAdminOrTeacher() ||
      // request.auth.uid == studentId; // (ì£¼ì˜: studentIdê°€ auth.uidì™€ ê°™ë‹¤ëŠ” ë³´ì¥ ì—†ìŒ)
      // student ë¬¸ì„œ ë‚´ë¶€ì— authUid í•„ë“œë¥¼ ì €ì¥í•˜ê³  ë¹„êµí•˜ëŠ” ë°©ì‹ì´ ë” ì¼ë°˜ì 
      allow write: if isAdminOrTeacher();
    }

    // =========================================
    // subjects ì»¬ë ‰ì…˜ (+ í•˜ìœ„ ì»¬ë ‰ì…˜)
    // =========================================
    match /subjects/{subjectId} {
      allow read: if isAuthenticated();
      allow write: if isAdminOrTeacher();

      match /textbooks/{textbookId} {
        allow read: if isAuthenticated();
        allow write: if isAdminOrTeacher();
      }

      match /lessons/{lessonId} {
        allow read: if isAuthenticated();
        allow write: if isAdminOrTeacher();

        // --- ğŸ‘‡ ìˆ˜ì •ëœ submissions ê·œì¹™ (studentDocId ì‚¬ìš©) ğŸ‘‡ ---
        match /submissions/{studentDocId} { // ë¬¸ì„œ IDë¥¼ í•™ìƒ Firestore ë¬¸ì„œ IDë¡œ ì‚¬ìš©
          // ì½ê¸°: êµì‚¬/ê´€ë¦¬ìë§Œ í—ˆìš© (í•™ìƒì€ ìê¸° ì§„í–‰ìƒí™©ì„ ì•± ë¡œì»¬ì—ì„œ ê´€ë¦¬)
          allow read: if isAdminOrTeacher();
          // ìƒì„±/ìˆ˜ì •: ë¡œê·¸ì¸í–ˆê³ , ì œì¶œí•˜ë ¤ëŠ” ë¬¸ì„œ IDê°€ ì‹¤ì œ ì œì¶œí•˜ëŠ” í•™ìƒì˜ ë¬¸ì„œ IDì™€ ì¼ì¹˜í•  ë•Œ
          // (ì£¼ì˜: í•™ìƒ ì•±ì—ì„œ studentDocIdë¥¼ ì˜¬ë°”ë¥´ê²Œ ì „ë‹¬í•´ì•¼ í•¨)
          // (ì£¼ì˜: request.resource.data.studentDocIdëŠ” ì“°ê¸°/ì—…ë°ì´íŠ¸ ì‹œì—ë§Œ ì‚¬ìš© ê°€ëŠ¥)
          allow create, update: if isAuthenticated() && request.resource.data.studentDocId == studentDocId;
          // ì‚­ì œ: êµì‚¬/ê´€ë¦¬ìë§Œ í—ˆìš©
          allow delete: if isAdminOrTeacher();
        }
        // --- ğŸ‘† ---
      }
    }

    // =========================================
    // lessons ì»¬ë ‰ì…˜ (ìµœìƒìœ„) - í˜„ì¬ ì‚¬ìš© ì•ˆ í•¨
    // =========================================
    match /lessons/{lessonId} {
      allow read: if isAuthenticated();
      allow write: if isAdminOrTeacher();
    }

    // =========================================
    // homeworks ì»¬ë ‰ì…˜ (+ í•˜ìœ„ submissions)
    // =========================================
    match /homeworks/{homeworkId} {
      allow read: if isAuthenticated();
      allow write: if isAdminOrTeacher(); // ìˆ™ì œ ìƒì„±/ìˆ˜ì •ì€ ê´€ë¦¬ì/êµì‚¬ë§Œ

      match /submissions/{studentDocId} { // ë¬¸ì„œ IDë¥¼ í•™ìƒ Firestore ë¬¸ì„œ IDë¡œ ì‚¬ìš©
        // ì½ê¸°: êµì‚¬/ê´€ë¦¬ìë§Œ í—ˆìš©
        allow read: if isAdminOrTeacher();
        // ì“°ê¸°(ìƒì„±/ìˆ˜ì •): ë¡œê·¸ì¸í–ˆê³ , ì œì¶œí•˜ë ¤ëŠ” ë¬¸ì„œ IDê°€ ì‹¤ì œ ì œì¶œí•˜ëŠ” í•™ìƒì˜ ë¬¸ì„œ IDì™€ ì¼ì¹˜í•  ë•Œ
        // (ì£¼ì˜: í•™ìƒ ì•±ì—ì„œ studentDocIdë¥¼ ì˜¬ë°”ë¥´ê²Œ ì „ë‹¬í•´ì•¼ í•¨)
        allow write: if isAuthenticated() && request.resource.data.studentDocId == studentDocId;
        // ì‚­ì œ: êµì‚¬/ê´€ë¦¬ìë§Œ í—ˆìš©
        allow delete: if isAdminOrTeacher();
      }
    }

    // =========================================
    // teachers ì»¬ë ‰ì…˜
    // =========================================
    match /teachers/{teacherId} {
      allow read, write: if isAdminOrTeacher();
    }

    // =========================================
    // classVideos / classLectures (ìˆ˜ì—…/ì§ˆë¬¸ ì˜ìƒ)
    // =========================================
    match /classVideos/{videoId} {
      allow read: if isAuthenticated();
      allow write: if isAdminOrTeacher();
    }
    match /classLectures/{lectureId} {
      allow read: if isAuthenticated();
      allow write: if isAdminOrTeacher();
    }

    // =========================================
    // ê¸°ë³¸ ê±°ë¶€
    // =========================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}