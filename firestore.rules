rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // =========================================
    // 공통 헬퍼 함수
    // =========================================
    
    // 1. 로그인 여부 확인
    function isAuthenticated() {
      return request.auth != null;
    }

    // 2. 관리자 또는 선생님 권한 확인
    function isAdminOrTeacher() {
      return isAuthenticated() 
             && 'role' in request.auth.token 
             && (request.auth.token.role == 'admin' || request.auth.token.role == 'teacher');
    }

    // =========================================
    // classes 컬렉션
    // =========================================
    match /classes/{classId} {
      allow read: if isAuthenticated();
      allow write: if isAdminOrTeacher();
    }

    // =========================================
    // students 컬렉션
    // =========================================
    match /students/{studentId} {
      allow read: if isAuthenticated();
      allow write: if isAdminOrTeacher();
    }

    // =========================================
    // subjects 컬렉션 (+ 하위 컬렉션)
    // =========================================
    match /subjects/{subjectId} {
      allow read: if isAuthenticated();
      allow write: if isAdminOrTeacher();

      match /textbooks/{textbookId} {
        allow read: if isAuthenticated();
        allow write: if isAdminOrTeacher();
      }

      match /lessons/{lessonId} {
        allow read: if isAuthenticated();
        allow write: if isAdminOrTeacher();

        match /submissions/{studentDocId} {
          // [수정됨] 읽기: 관리자/교사 OR 학생 본인
          allow read: if isAdminOrTeacher() || (isAuthenticated() && request.auth.uid == studentDocId);
          
          // 쓰기: 본인만 (데이터 ID와 인증 ID 일치 시)
          allow create, update: if isAuthenticated() && request.resource.data.studentDocId == studentDocId;
          
          // 삭제: 교사/관리자만
          allow delete: if isAdminOrTeacher();
        }
      }
    }

    // =========================================
    // homeworks 컬렉션 (+ 하위 submissions)
    // =========================================
    match /homeworks/{homeworkId} {
      allow read: if isAuthenticated();
      allow write: if isAdminOrTeacher();

      match /submissions/{studentDocId} {
        // ✅ [수정됨] 핵심: 학생 본인이면 자기 제출물을 읽을 수 있게 허용!
        allow read: if isAdminOrTeacher() || (isAuthenticated() && request.auth.uid == studentDocId);
        
        // 쓰기: 본인만
        allow write: if isAuthenticated() && request.resource.data.studentDocId == studentDocId;
        // 삭제: 교사/관리자만
        allow delete: if isAdminOrTeacher();
      }
    }

    // =========================================
    // teachers 컬렉션
    // =========================================
    match /teachers/{teacherId} {
      allow read, write: if isAdminOrTeacher();
    }

    // =========================================
    // classVideos / classLectures (수업/질문 영상)
    // =========================================
    match /classVideos/{videoId} {
      allow read: if isAuthenticated();
      allow write: if isAdminOrTeacher();
    }
    match /classLectures/{lectureId} {
      allow read: if isAuthenticated();
      allow write: if isAdminOrTeacher();
    }

    // =========================================
    // 기본 거부 (나머지 모든 경로는 차단)
    // =========================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}