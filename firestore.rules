rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // =========================================
    // 공통 헬퍼 함수
    // =========================================
    
    // 1. 로그인 여부 확인
    function isAuthenticated() {
      return request.auth != null;
    }

    // 2. 관리자 또는 선생님 권한 확인
    function isAdminOrTeacher() {
      return isAuthenticated() 
             && 'role' in request.auth.token 
             && (request.auth.token.role == 'admin' || request.auth.token.role == 'teacher');
    }

    // =========================================
    // classes 컬렉션 (반 목록)
    // =========================================
    match /classes/{classId} {
      // 로그인 전에도 반을 선택해야 하므로 read 허용
      allow read: if true; 
      allow write: if isAdminOrTeacher();
    }

    // =========================================
    // students 컬렉션 (학생 목록)
    // =========================================
    match /students/{studentId} {
      // 반 선택 후 이름을 찾아야 하므로 read 허용
      allow read: if true; 
      allow write: if isAdminOrTeacher();
    }

    // =========================================
    // textbooks / subjects / lessons (학습 데이터)
    // =========================================
    match /textbooks/{textbookId} {
      allow read: if true; 
      allow write: if isAdminOrTeacher();
    }

    match /subjects/{subjectId} {
      allow read: if true; 
      allow write: if isAdminOrTeacher();

      match /lessons/{lessonId} {
        allow read: if true; 
        allow write: if isAdminOrTeacher();

        match /submissions/{studentDocId} {
          // 제출물은 본인 혹은 관리자만
          allow read: if isAdminOrTeacher() || (isAuthenticated() && request.auth.uid == studentDocId);
          allow create, update: if isAuthenticated() && request.resource.data.studentDocId == studentDocId;
          allow delete: if isAdminOrTeacher();
        }
      }
    }

    // =========================================
    // homeworks / classVideos / reports
    // =========================================
    match /homeworks/{homeworkId} {
      allow read: if true;
      allow write: if isAdminOrTeacher();
      
      match /submissions/{studentDocId} {
        allow read: if isAdminOrTeacher() || (isAuthenticated() && request.auth.uid == studentDocId);
        allow write: if isAuthenticated() && request.resource.data.studentDocId == studentDocId;
      }
    }

    match /classVideos/{videoId} {
      allow read: if true;
      allow write: if isAdminOrTeacher();
    }
    
    match /classLectures/{lectureId} {
      allow read: if true;
      allow write: if isAdminOrTeacher();
    }

    match /reports/{reportId} {
      allow read: if true;
      allow write: if isAdminOrTeacher();
    }

    // 기본 거부
    match /{document=**} {
      allow read, write: if false;
    }
  }
}