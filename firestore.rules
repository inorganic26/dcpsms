rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // =========================================
    // 공통 헬퍼 함수
    // =========================================
    
    // 1. 로그인 여부 확인
    function isAuthenticated() {
      return request.auth != null;
    }

    // 2. 관리자 또는 선생님 권한 확인
    function isAdminOrTeacher() {
      return isAuthenticated() 
             && 'role' in request.auth.token 
             && (request.auth.token.role == 'admin' || request.auth.token.role == 'teacher');
    }

    // =========================================
    // classes 컬렉션 (반 목록)
    // =========================================
    match /classes/{classId} {
      allow read: if true;
      allow write: if isAdminOrTeacher();
    }

    // =========================================
    // teachers 컬렉션 (선생님 목록)
    // =========================================
    match /teachers/{teacherId} {
      allow read: if true;
      allow write: if isAdminOrTeacher();
    }

    // =========================================
    // students 컬렉션 (학생 목록)
    // =========================================
    match /students/{studentId} {
      allow read: if true;
      allow write: if isAdminOrTeacher();
    }

    // =========================================
    // textbooks / subjects / lessons (학습 데이터)
    // =========================================
    match /textbooks/{textbookId} {
      allow read: if true;
      allow write: if isAdminOrTeacher();
    }

    match /subjects/{subjectId} {
      allow read: if true;
      allow write: if isAdminOrTeacher();

      match /lessons/{lessonId} {
        allow read: if true;
        allow write: if isAdminOrTeacher();

        match /submissions/{studentDocId} {
          allow read: if isAdminOrTeacher() || (isAuthenticated() && request.auth.uid == studentDocId);
          allow create, update: if isAuthenticated() && request.resource.data.studentDocId == studentDocId;
          allow delete: if isAdminOrTeacher();
        }
      }
    }

    // =========================================
    // homeworks (숙제) - ✨ [수정됨] 학생 제출 허용
    // =========================================
    match /homeworks/{homeworkId} {
      allow read: if true;
      
      // ✨ 핵심 수정: 학생이 숙제를 제출(수정)할 수 있도록 허용
      allow update: if isAuthenticated(); 
      
      // 생성(숙제 내기)과 삭제(숙제 지우기)는 여전히 선생님/관리자만 가능
      allow create, delete: if isAdminOrTeacher();
      
      // (참고) 서브컬렉션 규칙
      match /submissions/{studentDocId} {
        allow read: if isAdminOrTeacher() || (isAuthenticated() && request.auth.uid == studentDocId);
        allow write: if isAuthenticated() && request.resource.data.studentDocId == studentDocId;
      }
    }

    // =========================================
    // classVideos / classLectures / reports
    // =========================================
    match /classVideos/{videoId} {
      allow read: if true;
      allow write: if isAdminOrTeacher();
    }
    
    match /classLectures/{lectureId} {
      allow read: if true;
      allow write: if isAdminOrTeacher();
    }

    match /reports/{reportId} {
      allow read: if true;
      allow write: if isAdminOrTeacher();
    }

    // =========================================
    // 일일 테스트 (daily_tests)
    // =========================================
    match /daily_tests/{testId} {
      allow read, write: if isAuthenticated();
    }

    // 기본 거부
    match /{document=**} {
      allow read, write: if false;
    }
  }
}