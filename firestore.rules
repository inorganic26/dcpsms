rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // 1. 기본 규칙: 모든 인증된 사용자에게 읽기 권한 허용
    match /{document=**} {
      allow read: if request.auth != null;
    }
    
    // 2. 관리 데이터 (classes, subjects, lessons, textbooks):
    // 관리자/선생님 앱의 쓰기 작업을 위해 인증된 사용자에게 허용
    match /classes/{classId} {
      allow write: if request.auth != null;
    }
    match /subjects/{subjectId} {
      allow write: if request.auth != null;
    }
    match /subjects/{subjectId}/textbooks/{textbookId} {
      allow write: if request.auth != null;
    }
    match /subjects/{subjectId}/lessons/{lessonId} {
      allow write: if request.auth != null;
    }

    // 3. 학생 데이터 (students):
    // 학생 명단 관리 및 로그인 조회를 위해 인증된 사용자에게 쓰기 허용
    match /students/{studentId} {
      allow write: if request.auth != null;
    }
    
    // 4. 숙제 및 학습 제출 기록 (Submissions):
    // 학생/선생님 앱의 기록 생성/수정 작업을 위해 인증된 사용자에게 허용
    match /homeworks/{homeworkId} {
      allow write: if request.auth != null; 
    }
    match /homeworks/{homeworkId}/submissions/{studentId} {
      allow write: if request.auth != null; 
    }
    match /subjects/{subjectId}/lessons/{lessonId}/submissions/{studentId} {
      allow write: if request.auth != null; 
    }
    
    // 5. AI 분석 결과 (testAnalysisResults, homeworkGradingResults):
    // Cloud Functions의 서버 쓰기 작업을 보장하기 위해 허용
    match /testAnalysisResults/{docId} {
        allow write: if true;
    }
    match /homeworkGradingResults/{docId} {
        allow write: if true;
    }
  }
}