rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- 헬퍼 함수 (교사/관리자용) ---
    // 교사/관리자는 Firebase Auth(이메일 등)로 로그인한다고 가정합니다.
    function isAuthenticated() {
      return request.auth != null;
    }
    function getUserRole(uid) {
      return get(/databases/$(database)/documents/users/$(uid)).data.role;
    }
    function isAdmin() {
      return isAuthenticated() && getUserRole(request.auth.uid) == 'admin';
    }
    function isTeacher() {
      return isAuthenticated() && getUserRole(request.auth.uid) == 'teacher';
    }

    // --- 학생 로그인 및 사용을 위한 공개 규칙 ---

    // [🚨 보안 경고] 
    // 학생 로그인 시 반 목록을 불러와야 하므로 누구나(if true) 읽을 수 있게 허용합니다.
    match /classes/{classId} {
      allow read: if true;
      allow write: if isAdmin() || isTeacher();
    }

    // [🚨🚨🚨 매우 심각한 보안 경고]
    // 학생 로그인 시 (이름, 비번)을 비교해야 하므로 누구나(if true) 읽을 수 있게 허용합니다.
    // 이 규칙은 'password' 필드를 포함한 모든 학생 정보를 외부에 노출시킵니다.
    match /students/{studentId} {
      allow read: if true;
      allow write: if isAdmin() || isTeacher();
    }

    // [🚨 보안 경고]
    // 학생이 로그인 후 수업, 과목, 교과서 정보를 읽어야 하므로 누구나(if true) 읽기 허용합니다.
    match /subjects/{docId} {
      allow read: if true;
      allow write: if isAdmin() || isTeacher();
    }
    match /textbooks/{docId} {
      allow read: if true;
      allow write: if isAdmin() || isTeacher();
    }
    match /lessons/{docId} {
      allow read: if true;
      allow write: if isAdmin() || isTeacher();
    }

    // [🚨🚨 매우 심각한 보안 경고]
    // 학생이 숙제를 읽고, 제출(쓰기)해야 하므로 누구나(if true) 읽고 쓰기를 허용합니다.
    // 이 규칙은 누구나 숙제 정보를 스팸처럼 마구 생성할 수 있게 허용합니다.
    match /homeworks/{homeworkId} {
      allow read: if true;
      allow write: if true; // 'create'와 'update'를 위해 'write'를 엽니다.
    }

    // --- 교사/관리자 전용 보안 규칙 ---

    // 'users' (교사/관리자 역할 정보)는 인증된 사용자만 접근
    match /users/{userId} {
      allow read, write: if isAdmin() || (isTeacher() && request.auth.uid == userId);
    }
    
    // 'teachers' (교사 정보)는 인증된 사용자만 접근
    match /teachers/{teacherId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin() || (isTeacher() && request.auth.uid == teacherId);
    }

    // (이 외의 모든 컬렉션은 기본적으로 접근 거부)
  }
}